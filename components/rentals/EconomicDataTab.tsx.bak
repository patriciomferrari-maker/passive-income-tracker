'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Upload, Plus, Trash2 } from 'lucide-react';

interface EconomicData {
    id: string;
    type: string;
    date: string;
    value: number;
}

export function EconomicDataTab() {
    const [activeSubTab, setActiveSubTab] = useState('ipc');
    const [ipcData, setIpcData] = useState<EconomicData[]>([]);
    const [tcData, setTcData] = useState<EconomicData[]>([]);
    const [loading, setLoading] = useState(true);

    // Form state
    const [showSingleForm, setShowSingleForm] = useState(false);
    const [showBulkForm, setShowBulkForm] = useState(false);
    const [date, setDate] = useState('');
    const [value, setValue] = useState('');
    const [bulkData, setBulkData] = useState('');

    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        try {
            const [ipcRes, tcRes] = await Promise.all([
                fetch('/api/economic-data/ipc'),
                fetch('/api/economic-data/tc')
            ]);

            const ipc = await ipcRes.json();
            const tc = await tcRes.json();

            if (Array.isArray(ipc)) setIpcData(ipc);
            if (Array.isArray(tc)) setTcData(tc);
        } catch (error) {
            console.error('Error loading economic data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleSingleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        const endpoint = activeSubTab === 'ipc' ? '/api/economic-data/ipc' : '/api/economic-data/tc';

        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date,
                    value: parseFloat(value)
                })
            });

            if (!res.ok) throw new Error('Error al guardar');

            await loadData();
            setDate('');
            setValue('');
            setShowSingleForm(false);
            alert('Dato guardado exitosamente');
        } catch (error) {
            console.error('Error saving data:', error);
            alert('Error al guardar el dato');
        }
    };

    const handleBulkSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        try {
            // Parse CSV-like data: YYYY-MM-DD,value
            const lines = bulkData.trim().split('\n');
            const records = lines.map(line => {
                const [date, value] = line.split(',').map(s => s.trim());
                return { date, value: parseFloat(value) };
            }).filter(r => r.date && !isNaN(r.value));

            if (records.length === 0) {
                alert('No se encontraron datos válidos. Formato: YYYY-MM-DD,valor');
                return;
            }

            const endpoint = activeSubTab === 'ipc' ? '/api/economic-data/ipc' : '/api/economic-data/tc';

            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bulk: records })
            });

            if (!res.ok) throw new Error('Error al cargar datos');

            await loadData();
            setBulkData('');
            setShowBulkForm(false);
            alert(`${records.length} registros cargados exitosamente`);
        } catch (error) {
            console.error('Error bulk uploading:', error);
            alert('Error al cargar los datos en lote');
        }
    };

    const handleFetchBlue = async () => {
        try {
            const res = await fetch('/api/economic-data/fetch-blue', {
                method: 'POST'
            });

            const result = await res.json();

            if (!res.ok) {
                throw new Error(result.details || 'Error al obtener cotización');
            }

            await loadData();
            alert(`✅ Dólar Blue obtenido: $${result.rate.toFixed(2)}\nFecha: ${new Date(result.date).toLocaleDateString('es-AR', { year: 'numeric', month: 'long' })}\nFuente: ${result.source}`);
        } catch (error) {
            console.error('Error fetching blue rate:', error);
            alert(`Error al obtener el dólar blue: ${error instanceof Error ? error.message : 'Error desconocido'}`);
        }
    };

    const handleFetchAmbito = async () => {
        if (!confirm('Esto va a traer datos históricos desde 2023 hasta hoy desde Ámbito.com. Puede tardar unos segundos. ¿Continuar?')) {
            return;
        }

        try {
            setLoading(true);

            const res = await fetch('/api/economic-data/fetch-ambito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    startDate: '2023-01-01',
                    endDate: new Date().toISOString().split('T')[0]
                })
            });

            const result = await res.json();

            if (!res.ok) {
                throw new Error(result.details || 'Error al obtener datos');
            }

            await loadData();
            alert(`✅ ${result.message}\n\nTotal: ${result.totalRecords} registros\nNuevos: ${result.created}\nActualizados: ${result.updated}\n\nFuente: ${result.source}`);
        } catch (error) {
            console.error('Error fetching from Ambito:', error);
            alert(`Error al obtener datos de Ámbito: ${error instanceof Error ? error.message : 'Error desconocido'}`);
        } finally {
            setLoading(false);
        }
    };

    const handleDelete = async (id: string) => {
        if (!confirm('¿Eliminar este dato?')) return;

        // Note: Delete endpoint would need to be implemented
        alert('Función de eliminación pendiente de implementación');
    };

    const currentData = activeSubTab === 'ipc' ? ipcData : tcData;
    const dataLabel = activeSubTab === 'ipc' ? 'IPC' : 'TC';
    const dataUnit = activeSubTab === 'ipc' ? '%' : '$';

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-white">Datos Económicos</h2>

            {/* Sub-tabs */}
            <div className="flex gap-2 border-b border-slate-700">
                <button
                    onClick={() => setActiveSubTab('ipc')}
                    className={`px-4 py-2 font-medium transition-colors ${activeSubTab === 'ipc'
                        ? 'text-white border-b-2 border-blue-500'
                        : 'text-slate-400 hover:text-white'
                        }`}
                >
                    IPC (Inflación)
                </button>
                <button
                    onClick={() => setActiveSubTab('tc')}
                    className={`px-4 py-2 font-medium transition-colors ${activeSubTab === 'tc'
                        ? 'text-white border-b-2 border-blue-500'
                        : 'text-slate-400 hover:text-white'
                        }`}
                >
                    Tipo de Cambio
                </button>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-3">
                <Button
                    onClick={() => setShowSingleForm(true)}
                    className="bg-blue-600 hover:bg-blue-700"
                >
                    <Plus className="mr-2" size={16} />
                    Agregar {dataLabel}
                </Button>
                <Button
                    onClick={() => setShowBulkForm(true)}
                    variant="outline"
                    className="border-slate-600 text-white hover:bg-slate-800"
                >
                    <Upload className="mr-2" size={16} />
                    Carga Masiva
                </Button>
                {activeSubTab === 'tc' && (
                    <>
                        <Button
                            onClick={handleFetchBlue}
                            variant="outline"
                            className="border-green-600 text-green-400 hover:bg-green-500/10"
                        >
                            <Upload className="mr-2" size={16} />
                            Traer Dólar Blue
                        </Button>
                        <Button
                            onClick={handleFetchAmbito}
                            variant="outline"
                            className="border-purple-600 text-purple-400 hover:bg-purple-500/10"
                        >
                            <Upload className="mr-2" size={16} />
                            Histórico Ámbito
                        </Button>
                    </>
                )}
            </div>

            {/* Data Table */}
            <Card className="bg-slate-950 border-slate-800">
                <CardContent className="p-0">
                    {loading ? (
                        <div className="text-slate-400 text-center py-12">Cargando...</div>
                    ) : currentData.length === 0 ? (
                        <div className="text-slate-400 text-center py-12">
                            <p>No hay datos de {dataLabel} cargados.</p>
                            <p className="text-sm mt-2 text-slate-500">
                                {activeSubTab === 'ipc'
                                    ? 'Cargá valores mensuales de IPC para calcular ajustes automáticos'
                                    : 'Cargá cotizaciones diarias USD/ARS para conversión de monedas'}
                            </p>
                        </div>
                    ) : (
                        <div className="overflow-x-auto max-h-96">
                            <table className="w-full">
                                <thead className="sticky top-0 bg-slate-950">
                                    <tr className="border-b border-slate-800">
                                        <th className="text-left py-3 px-4 text-slate-300">Fecha</th>
                                        <th className="text-right py-3 px-4 text-slate-300">Valor</th>
                                        <th className="text-right py-3 px-4 text-slate-300">Acciones</th>
                                    </CardContent>
                                </Card>

                                {/* Single Entry Form Modal */}
                                {
                                    showSingleForm && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                            <Card className="w-full max-w-md bg-slate-900 border-slate-700">
                                                <CardHeader>
                                                    <CardTitle className="text-white">
                                                        Agregar {dataLabel}
                                                    </CardTitle>
                                                </CardHeader>
                                                <CardContent>
                                                    <form onSubmit={handleSingleSubmit} className="space-y-4">
                                                        <div>
                                                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                                                Fecha *
                                                            </label>
                                                            <input
                                                                type="month"
                                                                required
                                                                value={date}
                                                                onChange={e => setDate(e.target.value + '-01')}
                                                                className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                                                Valor * {activeSubTab === 'ipc' ? '(porcentaje, ej: 2.5 para 2.5%)' : '(pesos, ej: 1050.50)'}
                                                            </label>
                                                            <input
                                                                type="number"
                                                                required
                                                                min="0"
                                                                step="0.01"
                                                                value={value}
                                                                onChange={e => setValue(e.target.value)}
                                                                placeholder={activeSubTab === 'ipc' ? '2.5' : '1050.50'}
                                                                className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white"
                                                            />
                                                            <p className="text-xs text-slate-500 mt-1">
                                                                {activeSubTab === 'ipc'
                                                                    ? 'Ingresá el valor decimal (ej: 2.5 para 2.5%)'
                                                                    : 'Ingresá el valor del dólar en pesos'}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-3 pt-4">
                                                            <Button
                                                                type="button"
                                                                onClick={() => setShowSingleForm(false)}
                                                                variant="outline"
                                                                className="flex-1"
                                                            >
                                                                Cancelar
                                                            </Button>
                                                            <Button
                                                                type="submit"
                                                                className="flex-1 bg-blue-600 hover:bg-blue-700"
                                                            >
                                                                Guardar
                                                            </Button>
                                                        </div>
                                                    </form>
                                                </CardContent>
                                            </Card>
                                        </div>
                                    )
                                }

                                {/* Bulk Upload Form Modal */}
                                {
                                    showBulkForm && (
                                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                            <Card className="w-full max-w-2xl bg-slate-900 border-slate-700">
                                                <CardHeader>
                                                    <CardTitle className="text-white">
                                                        Carga Masiva de {dataLabel}
                                                    </CardTitle>
                                                </CardHeader>
                                                <CardContent>
                                                    <form onSubmit={handleBulkSubmit} className="space-y-4">
                                                        <div>
                                                            <label className="block text-sm font-medium text-slate-300 mb-1">
                                                                Datos (formato CSV: YYYY-MM-DD,valor)
                                                            </label>
                                                            <textarea
                                                                required
                                                                value={bulkData}
                                                                onChange={e => setBulkData(e.target.value)}
                                                                rows={10}
                                                                placeholder={activeSubTab === 'ipc'
                                                                    ? '2024-01-01,2.5\n2024-02-01,3.2\n2024-03-01,2.8'
                                                                    : '2024-01-01,1050.50\n2024-01-02,1055.00\n2024-01-03,1052.75'
                                                                }
                                                                className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white font-mono text-sm"
                                                            />
                                                            <p className="text-xs text-slate-500 mt-1">
                                                                Una línea por registro. Formato: YYYY-MM-DD,valor
                                                                {activeSubTab === 'ipc' && ' (valores decimales para IPC)'}
                                                            </p>
                                                        </div>
                                                        <div className="flex gap-3 pt-4">
                                                            <Button
                                                                type="button"
                                                                onClick={() => setShowBulkForm(false)}
                                                                variant="outline"
                                                                className="flex-1"
                                                            >
                                                                Cancelar
                                                            </Button>
                                                            <Button
                                                                type="submit"
                                                                className="flex-1 bg-blue-600 hover:bg-blue-700"
                                                            >
                                                                Cargar Datos
                                                            </Button>
                                                        </div>
                                                    </form>
                                                </CardContent>
                                            </Card>
                                        </div>
                                    )
                                }
                        </div >
                    );
}
