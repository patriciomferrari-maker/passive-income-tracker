// ===================================================================
// 0. CONFIGURACIÃ“N ÃšNICA DEL CALENDARIO IPC
// ===================================================================

/**
 * âš ï¸ REEMPLAZAR: ID del calendario donde se crearÃ¡n los eventos del IPC.
 * Debe ser el ID del calendario de Google (ej: tu.email@gmail.com o un ID de grupo).
 */
const CALENDAR_ID_IPC = "1ffeb27c4a9515826a453bc449dddc9a236362116422567e7a601bcd1b5f7708@group.calendar.google.com"; 
const IPC_EVENT_TITLE = "Ya se encuentra publicado el dato de InflaciÃ²n";


// ===================================================================
// 1. FUNCIONES DE INTERFAZ Y DISPARADOR
// ===================================================================

/**
 * Crea un menÃº dedicado SOLO para la calendarizaciÃ³n del IPC.
 * Esta es una funciÃ³n simple onOpen (no requiere disparador instalable).
 */
function onOpenIPC() {
  SpreadsheetApp.getUi()
      .createMenu('ðŸ“ˆ Calendarizar IPC')
      .addItem('Ejecutar CalendarizaciÃ³n IPC Manualmente', 'calendarizarDatoIPC')
      .addToUi();
}

/**
 * FunciÃ³n que se ejecuta automÃ¡ticamente al editar la hoja "Dato IPC".
 * âš ï¸ DEBE CONFIGURARSE UN DISPARADOR INSTALABLE (TRIGGER) 'Al editarse' para esta funciÃ³n (onEditIPC).
 * @param {GoogleAppsScript.Events.SheetsOnEdit} e Evento de ediciÃ³n.
 */
function onEditIPC(e) {
  if (!e || !e.source) return;
  
  const sheetName = e.source.getActiveSheet().getName();

  if (sheetName === "Dato IPC") {
    calendarizarDatoIPC(); 
    
    SpreadsheetApp.getActiveSpreadsheet().toast(
        'CalendarizaciÃ³n de IPC actualizada.', 
        'ActualizaciÃ³n AutomÃ¡tica IPC', 3
    );
  }
}

// ===================================================================
// 2. LÃ“GICA DE CALENDARIZACIÃ“N DE IPC (CON NOTIFICACIÃ“N)
// ===================================================================

/**
 * Lee las fechas de la Columna B de la hoja "Dato IPC", LIMPIA todos los eventos
 * anteriores con el mismo tÃ­tulo y crea los nuevos eventos a las 16:00 hs con una alerta.
 */
function calendarizarDatoIPC() {
  // 1. VerificaciÃ³n de ID y Hoja
  if (typeof CALENDAR_ID_IPC === 'undefined' || !CALENDAR_ID_IPC || CALENDAR_ID_IPC === "") {
    SpreadsheetApp.getUi().alert("âŒ ERROR: La constante CALENDAR_ID_IPC no estÃ¡ definida o estÃ¡ vacÃ­a.");
    return;
  }
  
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName("Dato IPC");
  
  if (!sh) {
    SpreadsheetApp.getUi().alert(`âŒ ERROR: La hoja "Dato IPC" no fue encontrada.`);
    return;
  }
  
  // 2. ObtenciÃ³n del Calendario y definiciÃ³n de rango de bÃºsqueda
  let calendar;
  try {
      calendar = CalendarApp.getCalendarById(CALENDAR_ID_IPC);
  } catch (e) {
      SpreadsheetApp.getUi().alert("âŒ ERROR: No se pudo conectar al calendario IPC. Verifique el ID.");
      return;
  }
 
  const today = new Date();
  // Busca eventos futuros hasta 5 aÃ±os
  const nextFiveYears = new Date(today.getFullYear() + 5, today.getMonth(), today.getDate()); 
  
  // 3. LIMPIEZA GARANTIZADA de eventos anteriores
  const eventsToDelete = calendar.getEvents(today, nextFiveYears, {search: IPC_EVENT_TITLE});
  
  eventsToDelete.forEach(event => {
    // Solo borra eventos que coinciden EXACTAMENTE con el tÃ­tulo.
    if (event.getTitle() === IPC_EVENT_TITLE) {
      event.deleteEvent();
    }
  });

  // 4. IteraciÃ³n y creaciÃ³n de nuevos eventos
  const dateRange = sh.getRange('B2:B' + sh.getLastRow()).getValues(); 
  let eventsCreated = 0;
  
  dateRange.forEach(row => {
    const dateValue = row[0];
    
    if (dateValue instanceof Date && !isNaN(dateValue)) {
      
      // Creamos la fecha y hora de inicio a las 16:00 (4 PM)
      const eventStart = new Date(dateValue.getFullYear(), dateValue.getMonth(), dateValue.getDate(), 16, 0, 0);
      
      // Hora de finalizaciÃ³n (30 minutos despuÃ©s)
      const eventEnd = new Date(eventStart.getTime() + (30 * 60 * 1000));
      
      // Solo calendarizamos eventos que estÃ¡n en el futuro
      if (eventStart.getTime() > today.getTime()) {
           // ðŸ”‘ CREACIÃ“N DEL EVENTO Y ALMACENAMIENTO
           const event = calendar.createEvent(IPC_EVENT_TITLE, eventStart, eventEnd);
           
           // AÃ‘ADIR RECORDATORIO: 0 minutos antes (A las 16:00 hs)
           event.addPopupReminder(0); 
           
           eventsCreated++;
      }
    }
  });

  // 5. Mensaje de resultado 
  // arguments.length === 0 indica que fue llamado manualmente (no por un evento 'e')
  if (eventsCreated > 0 && arguments.length === 0) { 
    SpreadsheetApp.getUi().alert(`âœ… Se han calendarizado ${eventsCreated} eventos de IPC.`);
  }
}