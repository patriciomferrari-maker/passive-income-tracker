generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id                         String                      @id @default(cuid())
  email                      String                      @unique
  password                   String
  name                       String?
  role                       String                      @default("USER")
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  resetToken                 String?                     @unique
  resetTokenExpiry           DateTime?
  dataOwnerId                String?
  appSettings                AppSettings?
  bankOperations             BankOperation[]
  barbosaCategorizationRules BarbosaCategorizationRule[]
  barbosaCategories          BarbosaCategory[]
  barbosaCleaning            BarbosaCleaning[]
  barbosaInstallmentPlans    BarbosaInstallmentPlan[]
  barbosaRecurrences         BarbosaRecurrence[]
  barbosaTransactions        BarbosaTransaction[]
  costaCategories            CostaCategory[]
  costaNotes                 CostaNote[]
  costaTransactions          CostaTransaction[]
  debts                      Debt[]
  dollarPurchases            DollarPurchase[]
  dollarSources              DollarSource[]
  investments                Investment[]
  monthlySummaries           MonthlySummary[]
  notifications              Notification[]
  properties                 Property[]
  accessGiven                SharedAccess[]              @relation("AccessGiven")
  accessReceived             SharedAccess[]              @relation("AccessReceived")
  dataOwner                  User?                       @relation("ActiveContext", fields: [dataOwnerId], references: [id])
  dataViewers                User[]                      @relation("ActiveContext")
  userHoldings               UserHolding[]
}

model DollarSource {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model DollarPurchase {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime
  amount    Float
  rate      Float?
  amountARS Float?
  source    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
}

model Property {
  id                String         @id @default(cuid())
  userId            String
  name              String
  address           String?
  electricityId     String?
  gasId             String?
  municipalId       String?
  hasGarage         Boolean        @default(false)
  garageMunicipalId String?
  isConsolidated    Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  role              String         @default("OWNER")
  jurisdiction      Jurisdiction   @default(PROVINCIA)
  aysaId            String?
  contracts         Contract[]
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  utilityChecks     UtilityCheck[]

  @@index([userId])
}

model Contract {
  id                  String           @id @default(cuid())
  propertyId          String
  tenantName          String?
  startDate           DateTime
  durationMonths      Int              @default(12)
  initialRent         Float
  currency            String           @default("ARS")
  documentUrl         String?
  warrantyAmount      Float?
  warrantyCurrency    String           @default("USD")
  adjustmentType      String           @default("IPC")
  adjustmentFrequency Int              @default(12)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  property            Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  rentalCashflows     RentalCashflow[]

  @@index([propertyId])
}

model RentalCashflow {
  id               String   @id @default(cuid())
  contractId       String
  date             DateTime
  monthIndex       Int
  amountARS        Float?
  amountUSD        Float?
  ipcMonthly       Float?
  ipcAccumulated   Float?
  tc               Float?
  tcBase           Float?
  tcClosingMonth   Float?
  inflationAccum   Float?
  devaluationAccum Float?
  createdAt        DateTime @default(now())
  contract         Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([date])
}

model Investment {
  id                    String                 @id @default(cuid())
  userId                String
  ticker                String
  name                  String
  type                  String
  currency              String                 @default("USD")
  emissionDate          DateTime?
  couponRate            Float?
  frequency             Int?
  maturityDate          DateTime?
  amortization          String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  lastPrice             Float?
  lastPriceDate         DateTime?
  market                String                 @default("US")
  sector                String?
  amortizationSchedules AmortizationSchedule[]
  assetPrices           AssetPrice[]
  cashflows             Cashflow[]
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]

  @@unique([userId, ticker])
  @@index([userId])
}

model GlobalAsset {
  id            String             @id @default(cuid())
  ticker        String             @unique
  name          String
  type          String
  currency      String             @default("ARS")
  market        String             @default("ARG")
  lastPrice     Float?
  lastPriceDate DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  ratio         String?
  sector        String?
  assetPrices   GlobalAssetPrice[]
  userHoldings  UserHolding[]

  @@index([type])
  @@index([ticker])
}

model UserHolding {
  id           String                   @id @default(cuid())
  userId       String
  assetId      String
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  transactions GlobalAssetTransaction[]
  asset        GlobalAsset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user         User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, assetId])
  @@index([userId])
  @@index([assetId])
}

model GlobalAssetPrice {
  id        String      @id @default(cuid())
  assetId   String
  date      DateTime
  price     Float
  currency  String      @default("ARS")
  createdAt DateTime    @default(now())
  asset     GlobalAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([date])
}

model GlobalAssetTransaction {
  id          String      @id @default(cuid())
  holdingId   String
  date        DateTime
  type        String
  quantity    Float
  price       Float
  commission  Float       @default(0)
  totalAmount Float
  currency    String
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  holding     UserHolding @relation(fields: [holdingId], references: [id], onDelete: Cascade)

  @@index([holdingId])
  @@index([date])
}

model AssetPrice {
  id           String     @id @default(cuid())
  investmentId String
  date         DateTime
  price        Float
  currency     String     @default("USD")
  createdAt    DateTime   @default(now())
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([date])
}

model AmortizationSchedule {
  id           String     @id @default(cuid())
  investmentId String
  paymentDate  DateTime
  percentage   Float
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@unique([investmentId, paymentDate])
}

model Transaction {
  id           String     @id @default(cuid())
  investmentId String
  date         DateTime
  type         String
  quantity     Float
  price        Float
  commission   Float      @default(0)
  totalAmount  Float
  currency     String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  notes        String?
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
}

model Cashflow {
  id              String     @id @default(cuid())
  investmentId    String
  date            DateTime
  amount          Float
  currency        String
  type            String
  status          String     @default("PROJECTED")
  description     String?
  capitalResidual Float?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  investment      Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([date])
}

model EconomicIndicator {
  id               String   @id @default(cuid())
  type             String
  date             DateTime
  value            Float
  interannualValue Float?
  buyRate          Float?
  sellRate         Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isManual         Boolean? @default(false)

  @@unique([type, date])
}

model UtilityCheck {
  id             String    @id @default(cuid())
  propertyId     String
  serviceType    String
  checkDate      DateTime  @default(now())
  status         String
  debtAmount     Float?
  lastBillAmount Float?
  lastBillDate   DateTime?
  dueDate        DateTime?
  isAutomatic    Boolean   @default(true)
  errorMessage   String?
  createdAt      DateTime  @default(now())
  property       Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Debt {
  id            String        @id @default(cuid())
  userId        String
  debtorName    String
  startDate     DateTime
  initialAmount Float
  currency      String        @default("USD")
  status        String        @default("ACTIVE")
  details       String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  type          String        @default("OWED_TO_ME")
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments      DebtPayment[]

  @@index([userId])
}

model DebtPayment {
  id          String   @id @default(cuid())
  debtId      String
  date        DateTime
  amount      Float
  type        String   @default("PAYMENT")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  debt        Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@index([debtId])
}

model BankOperation {
  id           String    @id @default(cuid())
  userId       String
  type         String
  alias        String?
  amount       Float
  currency     String    @default("ARS")
  startDate    DateTime?
  durationDays Int?
  tna          Float?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CostaCategory {
  id           String             @id @default(cuid())
  userId       String
  name         String
  type         String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CostaTransaction[]

  @@index([userId])
}

model CostaTransaction {
  id                  String         @id @default(cuid())
  userId              String?
  date                DateTime
  type                String
  description         String?
  amount              Float
  currency            String         @default("USD")
  categoryId          String?
  rentalCheckOut      DateTime?
  contractUrl         String?
  linkedTransactionId String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  rentalCheckIn       DateTime?
  category            CostaCategory? @relation(fields: [categoryId], references: [id])
  user                User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CostaNote {
  id        String   @id @default(cuid())
  userId    String?
  content   String
  category  String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MonthlySummary {
  id               String   @id @default(cuid())
  userId           String
  month            Int
  year             Int
  totalNetWorthUSD Float
  totalIncomeUSD   Float
  snapshotData     Json
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
}

model AppSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  notificationEmails String   @default("")
  reportDay          Int      @default(1)
  reportHour         Int      @default(10)
  enabledSections    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InflationData {
  id        String   @id @default(cuid())
  year      Int
  month     Int
  value     Float
  updatedAt DateTime @updatedAt

  @@unique([year, month])
}

model AccessLog {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  action    String
  status    String
  ip        String?
  userAgent String?
  details   String?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

model BarbosaCategory {
  id                  String                      @id @default(cuid())
  userId              String
  name                String
  type                String
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  categorizationRules BarbosaCategorizationRule[]
  user                User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  installmentPlans    BarbosaInstallmentPlan[]
  recurrences         BarbosaRecurrence[]
  subCategories       BarbosaSubCategory[]
  transactions        BarbosaTransaction[]

  @@index([userId])
}

model BarbosaSubCategory {
  id           String               @id @default(cuid())
  categoryId   String
  name         String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  recurrences  BarbosaRecurrence[]
  category     BarbosaCategory      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  transactions BarbosaTransaction[]

  @@index([categoryId])
}

model BarbosaTransaction {
  id                  String                  @id @default(cuid())
  userId              String
  date                DateTime
  type                String
  amount              Float
  currency            String                  @default("ARS")
  exchangeRate        Float?
  amountUSD           Float?
  categoryId          String
  subCategoryId       String?
  description         String?
  linkedTransactionId String?
  status              String                  @default("REAL")
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  isStatistical       Boolean                 @default(false)
  installmentPlanId   String?
  attachmentUrl       String?
  importSource        String?
  comprobante         String?
  category            BarbosaCategory         @relation(fields: [categoryId], references: [id])
  installmentPlan     BarbosaInstallmentPlan? @relation(fields: [installmentPlanId], references: [id], onDelete: Cascade)
  subCategory         BarbosaSubCategory?     @relation(fields: [subCategoryId], references: [id])
  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([installmentPlanId])
  @@index([comprobante])
}

model BarbosaRecurrence {
  id            String              @id @default(cuid())
  userId        String
  name          String
  dayOfMonth    Int
  amount        Float
  currency      String              @default("ARS")
  type          String
  categoryId    String
  subCategoryId String?
  active        Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  isStatistical Boolean             @default(false)
  category      BarbosaCategory     @relation(fields: [categoryId], references: [id])
  subCategory   BarbosaSubCategory? @relation(fields: [subCategoryId], references: [id])
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BarbosaCleaning {
  id              String   @id @default(cuid())
  userId          String
  month           Int
  year            Int
  weeklyValue     Float
  hoursPerWeek    Int
  pricePerHour    Float
  monthlyIncrease Float
  paidValue       Float
  legalHourlyRate Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
}

model BarbosaInstallmentPlan {
  id                String               @id @default(cuid())
  userId            String
  description       String
  totalAmount       Float
  currency          String               @default("ARS")
  installmentsCount Int
  startDate         DateTime
  categoryId        String
  subCategoryId     String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  category          BarbosaCategory      @relation(fields: [categoryId], references: [id])
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      BarbosaTransaction[]

  @@index([userId])
}

model BarbosaCategorizationRule {
  id            String          @id @default(cuid())
  userId        String
  pattern       String
  categoryId    String
  subCategoryId String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  category      BarbosaCategory @relation(fields: [categoryId], references: [id])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pattern])
  @@index([userId])
}

model SharedAccess {
  id        String   @id @default(cuid())
  ownerId   String
  viewerId  String
  createdAt DateTime @default(now())
  owner     User     @relation("AccessGiven", fields: [ownerId], references: [id], onDelete: Cascade)
  viewer    User     @relation("AccessReceived", fields: [viewerId], references: [id], onDelete: Cascade)

  @@unique([ownerId, viewerId])
  @@index([ownerId])
  @@index([viewerId])
}

model AssetSplitHistory {
  id         String   @id @default(cuid())
  ticker     String
  oldRatio   String
  newRatio   String
  multiplier Float
  applied    Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@index([ticker])
  @@index([createdAt])
}

model CedearDividend {
  id               String    @id @default(cuid())
  ticker           String
  companyName      String
  announcementDate DateTime
  paymentDate      DateTime?
  recordDate       DateTime?
  exDate           DateTime?
  amount           Float?
  currency         String    @default("USD")
  pdfUrl           String?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([ticker, announcementDate])
  @@index([ticker])
  @@index([announcementDate])
  @@index([paymentDate])
}

enum Jurisdiction {
  CABA
  PROVINCIA
}
