// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

// =================================================================
// USERS & AUTH
// =================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed
  name      String?
  role      String   @default("USER") // USER, ADMIN
  
  // Relations
  properties      Property[]
  investments     Investment[]
  debts           Debt[]
  bankOperations  BankOperation[]
  costaCategories CostaCategory[]
  costaTransactions CostaTransaction[]
  costaNotes      CostaNote[]
  
  // Barbosa Relations
  barbosaCategories BarbosaCategory[]
  barbosaTransactions BarbosaTransaction[]
  barbosaCleaning BarbosaCleaning[]
  barbosaRecurrences BarbosaRecurrence[]

  monthlySummaries MonthlySummary[]
  appSettings     AppSettings[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// REAL ESTATE (ALQUILERES)
// =================================================================

model Property {
  id        String     @id @default(cuid())
  userId    String     // Owner
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  address   String?
  role      String    @default("OWNER") // OWNER, TENANT
  
  // Utilities & Taxes IDs
  electricityId String?
  gasId         String?
  municipalId   String?
  
  // Garage
  hasGarage     Boolean    @default(false)
  garageMunicipalId String?

  isConsolidated Boolean   @default(true) // Whether to include in Global Dashboard

  contracts Contract[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@index([userId])
}

model Contract {
  id                  String           @id @default(cuid())
  propertyId          String
  property            Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  tenantName          String?
  startDate           DateTime         // Fecha de concertación
  durationMonths      Int              @default(12) // Plazo en meses
  
  initialRent         Float            // Alquiler inicial
  currency            String           @default("ARS") // ARS, USD
  documentUrl         String?          // URL del contrato (Word/PDF)
  
  // Warranty
  warrantyAmount      Float?
  warrantyCurrency    String           @default("USD")

  adjustmentType      String           @default("IPC") // IPC, NONE
  adjustmentFrequency Int              @default(12) // Meses entre ajustes (6, 12, etc.)
  
  rentalCashflows     RentalCashflow[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  @@index([propertyId])
}

model RentalCashflow {
  id                String    @id @default(cuid())
  contractId        String
  contract          Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  date              DateTime  // Fecha de pago
  monthIndex        Int       // Mes #1, #2, etc.
  
  amountARS         Float?    // Valor en ARS
  amountUSD         Float?    // Valor en USD
  
  ipcMonthly        Float?    // IPC del mes
  ipcAccumulated    Float?    // IPC acumulado período ajuste
  tc                Float?    // Tipo de cambio del mes
  tcBase            Float?    // TC base del contrato
  tcClosingMonth    Float?    // TC cierre mes para cálculos
  
  inflationAccum    Float?    // Inflación acumulada total
  devaluationAccum  Float?    // Devaluación acumulada total
  
  createdAt         DateTime  @default(now())
  
  @@index([contractId])
  @@index([date])
}

// =================================================================
// INVESTMENTS (ONs & TREASURIES)
// =================================================================

model Investment {
  id           String        @id @default(cuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  ticker       String
  name         String
  type         String        // ON, TREASURY, CEDEAR, etc.
  currency     String        @default("USD")
  
  // Contractual details for ONs/Treasuries
  emissionDate DateTime?     // Fecha de emisión
  couponRate   Float?        // Annual interest rate (e.g. 0.08 for 8%)
  frequency    Int?          // Payment frequency in months (e.g. 6 for semiannual)
  maturityDate DateTime?
  amortization String?       // BULLET, PERSONALIZADA
  
  transactions            Transaction[]
  cashflows               Cashflow[]
  amortizationSchedules   AmortizationSchedule[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Market Data (New)
  lastPrice    Float?        // Ultimo precio de cierre conocido
  lastPriceDate DateTime?    // Fecha del ultimo precio

  assetPrices  AssetPrice[]
  
  market       String        @default("US") // US, ARG
  
  @@unique([userId, ticker]) // Tickers unique per User, not global
  @@index([userId])
}

model AssetPrice {
  id           String     @id @default(cuid())
  investmentId String
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  
  date         DateTime
  price        Float
  currency     String     @default("USD")
  
  createdAt    DateTime   @default(now())
  
  @@index([investmentId])
  @@index([date])
}

model AmortizationSchedule {
  id           String     @id @default(cuid())
  investmentId String
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  
  paymentDate  DateTime
  percentage   Float      // Percentage of capital to amortize (0.0 to 1.0)
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  @@unique([investmentId, paymentDate])
}

model Transaction {
  id           String     @id @default(cuid())
  investmentId String
  investment   Investment @relation(fields: [investmentId], references: [id])
  
  date         DateTime
  type         String     // BUY, SELL
  
  quantity     Float
  price        Float
  commission   Float      @default(0)
  totalAmount  Float      // quantity * price + commission (usually negative for buys)
  currency     String
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// =================================================================
// CASHFLOW (PROJECTIONS & ACTUALS)
// =================================================================

model Cashflow {
  id           String      @id @default(cuid())
  
  // For investments only (ONs and Treasuries)
  investmentId String
  investment   Investment  @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  
  date         DateTime
  amount       Float
  currency     String
  
  type         String      // INTEREST, AMORTIZATION
  status       String      @default("PROJECTED") // PROJECTED, PAID
  
  description  String?     // Extra details (e.g. "Cuota 1/12")
  capitalResidual Float?    // Remaining capital after this cashflow

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  @@index([investmentId])
  @@index([date])
}

// =================================================================
// ECONOMIC DATA
// =================================================================

// ECONOMIC DATA IS GLOBAL (SHARED)
model EconomicIndicator {
  id        String   @id @default(cuid())
  type      String   // IPC, TC_USD_ARS, etc.
  date      DateTime
  value     Float    // Monthly variation (for IPC)
  
  interannualValue Float?  // Interannual inflation (scraped from datosmacro)
  
  buyRate   Float?   // Tipo de cambio comprador
  sellRate  Float?   // Tipo de cambio vendedor
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, date]) // Prevent duplicate entries for same month/day
}

// =================================================================
// DEBT TRACKER (PRESTAMOS/DEUDAS)
// =================================================================

model Debt {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  debtorName    String    // Nombre del deudor/acreedor
  type          String    @default("OWED_TO_ME") // OWED_TO_ME, I_OWE
  startDate     DateTime  // Fecha de inicio de la deuda
  initialAmount Float     // Monto inicial
  currency      String    @default("USD") // Moneda (USD, ARS)
  status        String    @default("ACTIVE") // ACTIVE, PAID
  details       String?   // Detalle / Concepto


  payments      DebtPayment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
}

model DebtPayment {
  id          String   @id @default(cuid())
  debtId      String
  debt        Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)
  
  date        DateTime // Fecha del pago
  amount      Float    // Monto pagado
  type        String   @default("PAYMENT") // PAYMENT, INCREASE
  description String?  // Concepto (e.g. "Pago parcial 1")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([debtId])
}

// =================================================================
// BANK INVESTMENTS (PF, FCI, CAJA)
// =================================================================

model BankOperation {
  id            String   @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          String   // 'FCI', 'PLAZO_FIJO', 'CAJA_SEGURIDAD'
  alias         String?  // Name (e.g. "FCI Money Market", "PF Banco N")
  
  amount        Float    // Invested Amount or Current Value
  currency      String   @default("ARS")

  // Plazo Fijo Specifics
  startDate     DateTime? // Fecha Constitución
  durationDays  Int?      // Plazo (días)
  tna           Float?    // Tasa Nominal Anual (%)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

// =================================================================
// COSTA ESMERALDA (BEACH HOUSE)
// =================================================================

model CostaCategory {
  id        String @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String // e.g. "Alquiler", "Mantenimiento", "Expensas"
  type      String // INCOME, EXPENSE
  
  transactions CostaTransaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}


model CostaTransaction {
  id          String   @id @default(cuid())
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  date        DateTime // Fecha del movimiento
  type        String   // INCOME, EXPENSE
  description String?
  amount      Float
  currency    String   @default("USD")

  // Category Link
  categoryId  String?
  category    CostaCategory? @relation(fields: [categoryId], references: [id])

  // Rental Specifics (Only for INCOME/RENTAL)
  rentalCheckOut DateTime?
  contractUrl    String?

  linkedTransactionId String? // ID of the synced transaction in another module (e.g. Barbosa)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}

model CostaNote {
  id        String   @id @default(cuid())
  userId    String?
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  category  String   // 'FIX', 'BRING'
  status    String   @default("PENDING") // PENDING, DONE

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// =================================================================
// MONTHLY SUMMARIES (SNAPSHOTS)
// =================================================================

model MonthlySummary {
  id               String   @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  month            Int
  year             Int
  
  totalNetWorthUSD Float
  totalIncomeUSD   Float    // Active Rental Income + Projected Interest
  
  snapshotData     Json     // Detailed breakdown (Bank, Rentals, Investments)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([userId, month, year])
}

// =================================================================
// APP SETTINGS
// =================================================================

model AppSettings {
  id                 String   @id @default(cuid()) 
  userId             String   // Multi-user settings now!
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  notificationEmails String   @default("") // Comma separated emails
  reportDay          Int      @default(1)  // Day of month to run report (1-28)
  reportHour         Int      @default(10) // Hour of day (0-23) UTC. Default 10 UTC = 7 AM ART
  enabledSections    String?  // Comma separated list of enabled sections
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId]) // One settings profile per user
}

// =================================================================
// INFLATION DATA
// =================================================================

model InflationData {
  id        String   @id @default(cuid())
  year      Int
  month     Int
  value     Float    // Monthly variation %
  
  updatedAt DateTime @updatedAt

  @@unique([year, month])
}

// =================================================================
// SECURITY AUDIT LOGS
// =================================================================

model AccessLog {
  id        String   @id @default(cuid())
  userId    String?  // Nullable because failed attempts might not have a valid user ID
  email     String?  // Log the email attempted
  action    String   // 'LOGIN'
  status    String   // 'SUCCESS', 'FAILURE'
  ip        String?
  userAgent String?
  
  details   String?  // Failure reason

  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([createdAt])
}

// =================================================================
// BARBOSA (HIDDEN SECTION)
// =================================================================

model BarbosaCategory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String   // e.g. "Auto"
  type      String   // INCOME, EXPENSE
  
  subCategories BarbosaSubCategory[]
  transactions  BarbosaTransaction[]
  recurrences   BarbosaRecurrence[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model BarbosaSubCategory {
  id         String   @id @default(cuid())
  categoryId String
  category   BarbosaCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name       String   // e.g. "Seguro"
  
  transactions BarbosaTransaction[]
  recurrences  BarbosaRecurrence[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([categoryId])
}

model BarbosaTransaction {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date           DateTime
  type           String   // INCOME, EXPENSE
  
  // Amounts
  amount         Float    // Value in original currency
  currency       String   @default("ARS") // ARS, USD
  
  // Dollarized Value
  exchangeRate   Float?   // TC USD at moment of transaction
  amountUSD      Float?   // Calculated USD value
  
  // Categorization
  categoryId     String
  category       BarbosaCategory @relation(fields: [categoryId], references: [id])
  
  subCategoryId  String?
  subCategory    BarbosaSubCategory? @relation(fields: [subCategoryId], references: [id])
  
  description    String?
  
  linkedTransactionId String? // ID of the synced transaction in another module (e.g. Costa)
  
  status         String   @default("REAL") // REAL, PROJECTED
  isStatistical  Boolean  @default(false)  // If true, excluded from Totals (e.g. Credit Card expenses)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([userId])
  @@index([date])
}

model BarbosaRecurrence {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name           String   // e.g. "Seguro Auto"
  dayOfMonth     Int      // 1-31
  
  amount         Float
  currency       String   @default("ARS")
  
  type           String   // INCOME, EXPENSE
  categoryId     String
  category       BarbosaCategory @relation(fields: [categoryId], references: [id])
  
  subCategoryId  String?
  subCategory    BarbosaSubCategory? @relation(fields: [subCategoryId], references: [id])
  
  active         Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([userId])
}

model BarbosaCleaning {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  month          Int
  year           Int
  
  // Inputs
  weeklyValue    Float    // Valor de la semana (Base)
  hoursPerWeek   Int      // Horas por semana
  
  // Calculated/Input
  pricePerHour   Float    // Precio por hora
  monthlyIncrease Float   // Aumento mensual (%) 
  
  paidValue      Float    // Valor pagado final
  
  // Comparison
  legalHourlyRate Float?   // Precio por hora segun ley
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([userId, month, year])
}
